import streamlit as st
import os
from dotenv import load_dotenv
import openai
from typing import List, Dict, Any
import time
from rag_utils import FrenchLegalRAG
from config import DEMO_METRICS, PRICING_TIERS, LEGAL_DOCUMENT_TYPES
import glob

load_dotenv()

st.set_page_config(
    page_title="Assistant Juridique IA - Votre Expert L√©gal Instantan√©",
    page_icon="‚öñÔ∏è",
    layout="wide",
    initial_sidebar_state="expanded"
)

@st.cache_resource
def initialize_rag_system():
    """Initialize RAG system (cached for performance)"""
    try:
        rag = FrenchLegalRAG()
        return rag
    except Exception as e:
        st.error(f"‚ö†Ô∏è Erreur d'initialisation du syst√®me RAG: {str(e)}")
        st.info("üí° Mode d√©mo activ√© - les r√©ponses seront simul√©es")
        return None

def load_demo_documents():
    """Load demo documents for testing"""
    demo_files = glob.glob("/root/LearnRag/demo_docs/*.txt")
    demo_file_objects = []
    
    for file_path in demo_files:
        class MockFile:
            def __init__(self, path):
                self.name = os.path.basename(path)
                self.type = "text/plain"
                self._content = None
                self._path = path
            
            def read(self):
                if self._content is None:
                    with open(self._path, 'r', encoding='utf-8') as f:
                        self._content = f.read().encode('utf-8')
                return self._content
        
        demo_file_objects.append(MockFile(file_path))
    
    return demo_file_objects

def demo_response(question: str, num_files: int):
    """Generate a demo response for showcase purposes"""
    time.sleep(1)  # Simulate processing
    
    st.success("‚úÖ Analyse termin√©e (Mode D√©mo)")
    st.write("**üéØ R√©ponse:**")
    
    # Intelligent demo responses based on keywords
    question_lower = question.lower()
    
    if "obligation" in question_lower and "bailleur" in question_lower:
        response = """
**Obligations principales du bailleur selon le contrat de bail commercial :**

1. **D√©livrance des locaux** - Livrer les locaux en bon √©tat de r√©parations locatives
2. **Jouissance paisible** - Assurer la jouissance paisible des lieux lou√©s
3. **Grosses r√©parations** - Effectuer les grosses r√©parations selon l'article 606 du Code civil
4. **Entretien des parties communes** - Maintenir les parties communes en bon √©tat

Ces obligations sont d√©taill√©es dans l'Article 4 du contrat analys√©.
"""
    elif "p√©riode" in question_lower and "essai" in question_lower:
        response = """
**P√©riode d'essai dans le contrat de travail :**

- **Dur√©e :** 4 mois renouvelable une fois
- **Statut :** Contrat √† Dur√©e Ind√©termin√©e (CDI)
- **Poste :** D√©veloppeuse Senior

La p√©riode d'essai est conforme √† la dur√©e l√©gale pour un cadre (Article 6 du contrat).
"""
    elif "montant" in question_lower or "r√©clam" in question_lower:
        response = """
**Montants r√©clam√©s dans le jugement du Tribunal de Commerce :**

- **Principal :** 45 000 euros (factures impay√©es)
- **Int√©r√™ts l√©gaux :** √Ä compter de l'√©ch√©ance de chaque facture  
- **Indemnit√© forfaitaire :** 200 euros (5 factures √ó 40 euros)
- **Article 700 CPC :** 1 500 euros
- **Total r√©clam√© :** Environ 46 700 euros + int√©r√™ts

Jugement rendu le 15 novembre 2023 par le Tribunal de Commerce de Lyon.
"""
    else:
        response = f"""
Bas√© sur l'analyse de vos {num_files} documents juridiques, voici ma r√©ponse √† votre question :

"{question}"

**Analyse effectu√©e sur :**
‚Ä¢ Contrats commerciaux et de travail
‚Ä¢ D√©cisions de justice  
‚Ä¢ Statuts de soci√©t√©
‚Ä¢ Proc√©dures civiles

**M√©thodologie :** Recherche s√©mantique + analyse contextuelle fran√ßaise

*Note : Ceci est une d√©monstration. L'analyse compl√®te n√©cessite la configuration des cl√©s API.*
"""
    
    st.info(response)
    
    # Demo sources
    st.write("**üìö Sources cit√©es :**")
    demo_sources = [
        {"name": "contrat_bail_commercial.txt", "score": 0.95, "excerpt": "Article 4 - Obligations du bailleur..."},
        {"name": "contrat_travail_cdi.txt", "score": 0.87, "excerpt": "Article 6 - P√©riode d'essai fix√©e √† 4 mois..."},
        {"name": "jugement_tribunal_commerce.txt", "score": 0.92, "excerpt": "Condamne √† payer 45 000 euros..."}
    ]
    
    for source in demo_sources[:2]:  # Show top 2 sources
        with st.expander(f"üìÑ {source['name']} (Score: {source['score']})"):
            st.write(source["excerpt"])

def main():
    # Initialize RAG system
    rag_system = initialize_rag_system()
    
    # Header
    st.title("‚öñÔ∏è Assistant Juridique IA")
    st.subheader("Transformez 3 heures de recherche en 30 secondes")
    
    # Demo mode toggle
    demo_mode = st.toggle("üéØ Mode D√©mo (utilisez nos documents de test)", value=True)
    
    # Sidebar for file upload
    with st.sidebar:
        st.header("üìÅ Documents Juridiques")
        
        if demo_mode:
            # Load demo documents
            demo_files = load_demo_documents()
            st.info(f"üéØ Mode d√©mo: {len(demo_files)} documents charg√©s")
            uploaded_files = demo_files
            
            st.write("**Documents de d√©monstration:**")
            for file in demo_files:
                st.write(f"üìÑ {file.name}")
                
        else:
            uploaded_files = st.file_uploader(
                "Glissez-d√©posez vos documents",
                type=['pdf', 'txt', 'docx'],
                accept_multiple_files=True,
                help="Formats support√©s: PDF, TXT, DOCX"
            )
            
            if uploaded_files:
                st.success(f"‚úÖ {len(uploaded_files)} documents charg√©s")
                for file in uploaded_files:
                    st.write(f"üìÑ {file.name}")
        
        # Document types info
        st.subheader("üìã Types de documents support√©s")
        for doc_type, description in LEGAL_DOCUMENT_TYPES.items():
            st.write(f"‚Ä¢ {description}")
    
    # Main content area
    col1, col2 = st.columns([2, 1])
    
    with col1:
        st.header("üí¨ Posez vos questions juridiques")
        
        # Sample questions for demo
        st.subheader("üéØ Exemples de questions")
        sample_questions = [
            "Quelles sont les obligations du bailleur dans un contrat de bail ?",
            "R√©sumez les clauses de r√©siliation de ce contrat",
            "Trouvez les jurisprudences similaires √† cette affaire",
            "Quels sont les risques juridiques dans ce document ?",
            "Comparez les termes de ces contrats de travail"
        ]
        
        for i, question in enumerate(sample_questions):
            if st.button(f"üìù {question}", key=f"sample_{i}"):
                st.session_state.current_question = question
        
        # Chat interface
        st.subheader("üí≠ Votre Question")
        user_question = st.text_input(
            "Tapez votre question ici...",
            value=st.session_state.get('current_question', ''),
            placeholder="Ex: Quelles sont les clauses r√©solutoires dans ce bail commercial ?"
        )
        
        if st.button("üîç Analyser", type="primary"):
            if user_question:
                if not uploaded_files:
                    st.warning("‚ö†Ô∏è Veuillez d'abord charger vos documents dans la barre lat√©rale")
                else:
                    with st.spinner("üîç Recherche en cours..."):
                        if rag_system:
                            # Real RAG processing
                            try:
                                result = rag_system.analyze_legal_document(user_question, uploaded_files)
                                
                                if "error" in result:
                                    st.error(f"‚ùå {result['error']}")
                                else:
                                    st.success("‚úÖ Analyse termin√©e")
                                    
                                    # Display answer
                                    st.write("**üéØ R√©ponse:**")
                                    st.info(result["answer"])
                                    
                                    # Display sources
                                    if result.get("sources"):
                                        st.write("**üìö Sources cit√©es:**")
                                        for i, source in enumerate(result["sources"], 1):
                                            with st.expander(f"üìÑ {source['document']} (Score: {source['relevance_score']})"):
                                                st.write(source["excerpt"])
                                    
                                    # Display processing stats
                                    st.write("**üìä Statistiques de traitement:**")
                                    col_stat1, col_stat2 = st.columns(2)
                                    with col_stat1:
                                        st.metric("Documents trait√©s", result.get("documents_processed", 0))
                                    with col_stat2:
                                        st.metric("Fichiers analys√©s", result.get("total_files", 0))
                                        
                            except Exception as e:
                                st.error(f"‚ùå Erreur lors de l'analyse: {str(e)}")
                                # Fallback to demo mode
                                st.info("üéØ Basculement en mode d√©monstration")
                                demo_response(user_question, len(uploaded_files))
                        else:
                            # Demo mode response
                            demo_response(user_question, len(uploaded_files))
            else:
                st.error("‚ùå Veuillez saisir une question")
    
    with col2:
        st.header("üìä Statistiques en Temps R√©el")
        
        # Real-time metrics
        if uploaded_files:
            st.metric("Documents charg√©s", len(uploaded_files), f"+{len(uploaded_files)}")
            st.metric("Temps par recherche", DEMO_METRICS["time_saved_per_search"], "-85%")
        else:
            st.metric("Documents analys√©s", "0", "0")
            st.metric("Temps √©conomis√©", "0h", "0h")
        
        st.metric("Taux de pr√©cision", DEMO_METRICS["accuracy_rate"], "+5%")
        st.metric("Documents/seconde", DEMO_METRICS["documents_per_second"], "+50")
        
        st.header("üéØ Avantages Concurrentiels")
        st.success("‚úÖ R√©ponses en fran√ßais juridique")
        st.success("‚úÖ Sources avec citations pr√©cises")
        st.success("‚úÖ 100% conforme RGPD")
        st.success("‚úÖ Donn√©es priv√©es locales")
        st.success("‚úÖ Support expert fran√ßais")
        
        st.header("üí∞ ROI Imm√©diat")
        annual_savings = DEMO_METRICS["annual_savings"]
        st.info(f"""
        **√âconomies garanties :**
        - üïê 15h/semaine √©conomis√©es
        - üí∞ {annual_savings}/an en productivit√©  
        - üìà ROI: 300% d√®s la premi√®re ann√©e
        - ‚ö° Retour sur investissement: 3 mois
        """)
        
        # Pricing quick view
        st.header("üí∏ Tarification Transparente")
        
        pricing_tab1, pricing_tab2 = st.tabs(["üèÉ‚Äç‚ôÇÔ∏è Starter", "üöÄ Pro"])
        
        with pricing_tab1:
            starter = PRICING_TIERS["starter"]
            st.write(f"**Setup:** ‚Ç¨{starter['setup_fee']:,}")
            st.write(f"**Mensuel:** ‚Ç¨{starter['monthly_fee']:,}")
            st.write(f"**Max docs:** {starter['max_documents']:,}")
            
        with pricing_tab2:
            pro = PRICING_TIERS["professional"]
            st.write(f"**Setup:** ‚Ç¨{pro['setup_fee']:,}")
            st.write(f"**Mensuel:** ‚Ç¨{pro['monthly_fee']:,}")
            st.write(f"**Max docs:** {pro['max_documents']:,}")
        
        # Call to action
        st.header("üöÄ Pr√™t √† √âconomiser 15h/Semaine ?")
        
        col_cta1, col_cta2 = st.columns(2)
        with col_cta1:
            if st.button("üìû D√©mo Gratuite", type="primary"):
                st.balloons()
                st.success("üéâ Calendrier ouvert !")
                st.info("üìß contact@assistant-juridique-ia.fr")
                
        with col_cta2:
            if st.button("üí¨ WhatsApp", type="secondary"):
                st.info("üì± +33 6 12 34 56 78")
        
        # Social proof
        st.header("üèÜ Ils Nous Font Confiance")
        st.write("üè¢ **Cabinet Martin & Associ√©s** - 'Gain de temps incroyable'")
        st.write("‚öñÔ∏è **SCP Dupont-Legal** - 'Pr√©cision remarquable'")  
        st.write("üèõÔ∏è **Avocats & Partners** - 'ROI en 2 mois'")
        
        # Urgency element
        st.error("‚è∞ **Offre limit√©e:** Premi√®re installation √† -50% ce mois-ci !")

    # Footer
    st.markdown("---")
    st.markdown("""
    <div style='text-align: center; color: #666;'>
        <p>üîí Vos donn√©es restent priv√©es ‚Ä¢ Traitement local ‚Ä¢ Conforme RGPD</p>
        <p>D√©velopp√© sp√©cialement pour les cabinets d'avocats fran√ßais</p>
    </div>
    """, unsafe_allow_html=True)

if __name__ == "__main__":
    main()